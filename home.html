<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Image Upload</title>
    <link rel="stylesheet" href="./index.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  </head>
  <body>
    <div class="imageUpload">
      <input type="file" class="inp" onchange="getImageData(event)" multiple />
      <button onclick="selectImage()" class="selectImage">Select Images</button>
      <div class="metaData"></div>
      <div class="progressBar">
        <div class="progress"></div>
      </div>
      <button onclick="uploadImage()" class="upload">Upload</button>
      <span class="completeMsg"></span>
      <span class="loading">Loading...</span>
      <div class="images"></div>
    </div>

    <!-- The modal for sharing and copying link -->
    <div id="shareModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeShareModal()">&times;</span>
        <p>Image Shareable Link:</p>
        <input type="text" id="imageLink" readonly />
        <button onclick="copyLink()">Copy Link</button>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCw6XY2ywC4VUfFyNCgPb3JS0GI-wfmkas",
        authDomain: "cloud-project-f8d50.firebaseapp.com",
        projectId: "cloud-project-f8d50",
        storageBucket: "cloud-project-f8d50.appspot.com",
        messagingSenderId: "827269261220",
        appId: "1:827269261220:web:af45c88d4fdc6047e08331"
        };


      const app = firebase.initializeApp(firebaseConfig);
      const storage = firebase.storage();
      const inp = document.querySelector(".inp");
      const progressbar = document.querySelector(".progress");
      const img = document.querySelector(".img");
      const body = document.querySelector("body");
      const metaData = document.querySelector(".metaData");
      const images = document.querySelector(".images");
      const loading = document.querySelector(".loading");
      const imageUpload = document.querySelector(".imageUpload");
      const completeMsg = document.querySelector(".completeMsg");
      let file;
      let files;
      let fileName;
      let progress;
      let uploadedFileName;

      const selectImage = () => {
        inp.click();
      };

      const getImageData = (e) => {
        files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          let imageData = document.createElement("span");
          imageData.className = "filedata";
          imageData.style.display = "block";
          imageData.innerHTML = files[i].name;
          metaData.appendChild(imageData);
        }
      };

      const uploadImage = async () => {
        for (let i = 0; i < files.length; i++) {
          let url = await uploadProcess(
            files[i],
            Math.round(Math.random() * 9999) + files[i].name
          );
          if (url) {
            loading.style.display = "none";
            let imageContainer = document.createElement("div");
            imageContainer.className = "image-container";

            let image = document.createElement("img");
            image.style.display = "block";
            image.setAttribute("src", url);
            image.className = "img";
            imageContainer.appendChild(image);

            let imageName = document.createElement("p");
            imageName.innerHTML = "File Name: " + files[i].name;
            imageContainer.appendChild(imageName);

            let deleteButton = document.createElement("button");
            deleteButton.innerText = "Delete";
            deleteButton.className = "delete-button";
            deleteButton.addEventListener("click", () => {
              deleteImage(files[i].name);
            });
            imageContainer.appendChild(deleteButton);

            let shareButton = document.createElement("button");
            shareButton.innerText = "Share";
            shareButton.className = "share-button";
            shareButton.addEventListener("click", () => {
              openShareModal(url);
            });
            imageContainer.appendChild(shareButton);

            images.appendChild(imageContainer);
          }
          if (i === files.length - 1) {
            completeMsg.innerHTML = `${files.length} files uploaded successfully`;
          }
        }
      };

      const uploadProcess = (file, fileName) => {
        return new Promise((resolve, reject) => {
          const storageRef = storage.ref().child("myimages");
          const folderRef = storageRef.child(fileName);
          const uploadtask = folderRef.put(file);
          uploadtask.on(
            "state_changed",
            (snapshot) => {
              loading.style.display = "block";
              progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progress = Math.round(progress);
              progressbar.style.width = progress + "%";
              progressbar.innerHTML = progress + "%";
              uploadedFileName = snapshot.ref.name;
            },
            (error) => {
              reject(error);
            },
            () => {
              storage
                .ref("myimages")
                .child(uploadedFileName)
                .getDownloadURL()
                .then((url) => {
                  console.log("URL", url);
                  resolve(url);
                });
            }
          );
        });
      };

      // Function to delete an image
      const deleteImage = (fileName) => {
        const storageRef = storage.ref().child("myimages/" + fileName);
        storageRef
          .delete()
          .then(() => {
            // Remove the deleted image from the DOM
            const imageContainers = document.querySelectorAll(".image-container");
            imageContainers.forEach((container) => {
              const containerFileName = container
                .querySelector("p")
                .innerText.replace("File Name: ", "");
              if (containerFileName === fileName) {
                container.remove();
              }
              console.log("Image deleted successfully");
            });
          })
          .catch((error) => {
            console.error("Error deleting image:", error);
          });
      };

      // Function to open the sharing modal
      const openShareModal = (imageURL) => {
        const modal = document.getElementById("shareModal");
        const imageLink = document.getElementById("imageLink");
        imageLink.value = imageURL;
        modal.style.display = "block";
      };

      // Function to close the sharing modal
      const closeShareModal = () => {
        const modal = document.getElementById("shareModal");
        modal.style.display = "none";
      };

      // Function to copy the image link to the clipboard
      const copyLink = () => {
        const imageLink = document.getElementById("imageLink");
        imageLink.select();
        document.execCommand("copy");
        alert("Link copied to clipboard");
      };

      // List all images in the "myimages" folder
      const listAllImages = () => {
        const storageRef = storage.ref().child("myimages");
        storageRef.listAll().then((result) => {
          result.items.forEach((imageRef) => {
            imageRef.getDownloadURL().then((url) => {
              // Extract the file name without numbers
              const fileName = imageRef.name;

              let imageContainer = document.createElement("div");
              imageContainer.className = "image-container";

              let image = document.createElement("img");
              image.style.display = "block";
              image.setAttribute("src", url);
              image.className = "img";
              imageContainer.appendChild(image);

              let imageName = document.createElement("p");
              imageName.innerHTML = "File Name: " + fileName;
              imageContainer.appendChild(imageName);

              let deleteButton = document.createElement("button");
              deleteButton.innerText = "Delete";
              deleteButton.className = "delete-button";
              deleteButton.addEventListener("click", () => {
                deleteImage(fileName);
              });
              imageContainer.appendChild(deleteButton);

              let shareButton = document.createElement("button");
              shareButton.innerText = "Share";
              shareButton.className = "share-button";
              shareButton.addEventListener("click", () => {
                openShareModal(url);
              });
              imageContainer.appendChild(shareButton);

              images.appendChild(imageContainer);
            });
          });
        });
      };

      // Call the listAllImages function to display existing images
      listAllImages();
    </script>
  </body>
</html>

